<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Chiesa Apostolica Carini - Via Don Luigi Sturzo 188 Carini</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Icone per browser e scorciatoia su schermata Home -->
  <link rel="icon" type="image/png" href="icon.png">
  <link rel="apple-touch-icon" href="icon.png">

  <style>
    :root {
      --bg: #050608;
      --card: #111319;
      --accent: #ff8800;
      --accent-soft: rgba(255,136,0,0.15);
      --text: #f5f5f5;
      --muted: #999;
      --font-main: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    *{box-sizing:border-box;margin:0;padding:0;}

    body{
      font-family:var(--font-main);
      background:radial-gradient(circle at top,#202238 0,#050608 55%);
      color:var(--text);
      min-height:100vh;
    }

    .app{
      max-width:480px;
      margin:0 auto;
      min-height:100vh;
      display:flex;
      flex-direction:column;
      background:rgba(0,0,0,0.55);
    }

    header{
      padding:12px 16px;
      display:flex;
      align-items:center;
      gap:12px;
      border-bottom:1px solid rgba(255,255,255,0.08);
      background:linear-gradient(135deg,#191b25,#101019);
    }

    .logo{
      width:34px;
      height:34px;
      border-radius:12px;
      overflow:hidden;
      background:#000;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-shrink:0;
    }

    .logo img{
      width:100%;
      height:100%;
      object-fit:cover;
    }

    .titles h1{font-size:16px;font-weight:700;}
    .titles p{font-size:11px;color:var(--muted);margin-top:2px;}
    .pill{
      display:inline-flex;align-items:center;
      padding:2px 8px;border-radius:999px;
      border:1px solid rgba(255,255,255,0.2);
      font-size:9px;letter-spacing:.12em;
      text-transform:uppercase;color:var(--muted);
      margin-top:4px;gap:4px;
    }
    .pill span{width:4px;height:4px;border-radius:50%;background:var(--accent);}

    main{
      flex:1;
      padding:12px 14px 16px;
    }

    .tabs{
      display:flex;
      gap:6px;
      margin-bottom:12px;
      background:rgba(255,255,255,0.04);
      border-radius:999px;
      padding:4px;
      flex-wrap:wrap;
    }
    .tab{
      flex:1 1 0;border:none;background:transparent;
      color:var(--muted);font-size:13px;
      padding:6px 8px;border-radius:999px;
      cursor:pointer;
      text-align:center;
    }
    .tab.active{
      background:var(--accent-soft);
      color:var(--accent);
      font-weight:600;
    }

    .card{
      background:var(--card);
      border-radius:16px;
      padding:14px 14px 16px;
      border:1px solid rgba(255,255,255,0.08);
      margin-bottom:14px;
    }

    /* Header devozionale con data + freccia ieri + bottone Oggi */
    .dev-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-bottom:8px;
    }

    .nav-prev{
      border:none;
      background:transparent;
      color:var(--muted);
      font-size:11px;
      display:inline-flex;
      align-items:center;
      gap:4px;
      cursor:pointer;
      padding:4px 6px;
      border-radius:999px;
    }

    .nav-prev:hover{
      background:rgba(255,255,255,0.06);
    }

    .nav-prev[disabled]{
      opacity:0.3;
      cursor:default;
    }

    .nav-prev .arrow{
      font-size:12px;
      line-height:1;
    }

    .chip-date{
      display:inline-flex;align-items:center;
      gap:6px;padding:3px 9px;border-radius:999px;
      background:rgba(255,255,255,0.06);
      font-size:11px;color:var(--muted);
    }
    .chip-date span:first-child{
      width:6px;height:6px;border-radius:50%;background:var(--accent);
    }

    /* bottone "Oggi" */
    .nav-today{
      border:none;
      background:transparent;
      color:var(--accent);
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      cursor:pointer;
    }
    .nav-today:hover{
      background:rgba(255,255,255,0.06);
    }

    .dev-title{font-size:18px;font-weight:700;margin-bottom:4px;}
    .dev-ref{font-size:12px;color:var(--accent);margin-bottom:8px;text-transform:uppercase;letter-spacing:.08em;}
    .dev-verse{font-size:13px;color:#ccc;margin-bottom:10px;white-space:pre-line;}
    .dev-content{font-size:14px;line-height:1.5;color:#ddd;white-space:pre-line;}

    .section-title{font-size:13px;font-weight:600;text-transform:uppercase;letter-spacing:.12em;color:var(--muted);margin-bottom:8px;}

    textarea{
      width:100%;min-height:110px;resize:vertical;
      border-radius:12px;border:1px solid rgba(255,255,255,0.15);
      background:rgba(0,0,0,0.65);
      color:var(--text);padding:10px;font-size:14px;
      outline:none;
    }
    textarea::placeholder{color:#666;}

    .btn-row{display:flex;justify-content:flex-end;gap:8px;margin-top:10px;}
    .btn{
      border:none;border-radius:999px;padding:7px 14px;
      font-size:13px;cursor:pointer;
    }
    .btn-primary{background:var(--accent);color:#111;font-weight:600;}
    .btn-ghost{background:transparent;color:var(--muted);}
    .btn-ghost:hover{background:rgba(255,255,255,0.08);}
    .small-note{font-size:11px;color:var(--muted);margin-top:6px;}

    .diary-item{
      padding:9px 10px;border-radius:12px;
      border:1px solid rgba(255,255,255,0.12);
      margin-bottom:8px;
      background:rgba(0,0,0,0.5);
      cursor:pointer;
    }
    .diary-date{font-size:12px;color:var(--accent);margin-bottom:3px;}
    .diary-preview{font-size:13px;color:#ddd;max-height:40px;overflow:hidden;}

    .empty{text-align:center;font-size:13px;color:var(--muted);padding:14px 4px;}

    /* Eventi */
    .events-list{
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .event-item{
      padding:10px 11px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(0,0,0,0.5);
    }

    .event-date{
      font-size:12px;
      color:var(--accent);
      margin-bottom:3px;
    }

    .event-title{
      font-size:14px;
      font-weight:600;
      margin-bottom:2px;
    }

    .event-location{
      font-size:12px;
      color:var(--muted);
      margin-bottom:3px;
    }

    .event-desc{
      font-size:13px;
      color:#ddd;
      margin-bottom:4px;
    }

    .event-booking{
      font-size:12px;
      color:#ccc;
    }

    /* Appuntamenti */
    .field-group{
      margin-bottom:10px;
    }
    .field-label{
      font-size:12px;
      color:var(--muted);
      margin-bottom:4px;
    }
    .input-text{
      width:100%;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.15);
      background:rgba(0,0,0,0.65);
      color:var(--text);
      padding:8px 10px;
      font-size:14px;
      outline:none;
    }
    .input-text::placeholder{
      color:#666;
    }

    .days-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:4px;
    }
    .day-chip{
      display:inline-flex;
      align-items:center;
      gap:4px;
      font-size:12px;
      color:var(--muted);
      background:rgba(255,255,255,0.05);
      border-radius:999px;
      padding:4px 8px;
      cursor:pointer;
    }
    .day-chip input{
      accent-color:var(--accent);
    }

    footer{
      padding:6px 12px 10px;
      font-size:10px;color:var(--muted);
      text-align:center;
      border-top:1px solid rgba(255,255,255,0.06);
      background:rgba(0,0,0,0.7);
    }

    /* Home ‚Äì blocco Prossimo evento */
    .home-next-event{
      margin-top:14px;
      padding-top:10px;
      border-top:1px solid rgba(255,255,255,0.06);
    }
    .home-next-event-date{
      font-size:11px;
      color:var(--accent);
      margin-bottom:2px;
    }
    .home-next-event-title{
      font-size:13px;
      font-weight:600;
      margin-bottom:2px;
    }
    .home-next-event-loc{
      font-size:12px;
      color:var(--muted);
    }

    @media (max-width:480px){
      main{padding:10px 10px 12px;}
      .card{padding:12px 12px 14px;}
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="logo">
      <img src="icon.png" alt="Logo Chiesa Apostolica Carini">
    </div>
    <div class="titles">
      <h1>Chiesa Apostolica Carini</h1>
      <p>Ristoro giornaliero</p>
      <div class="pill"><span></span> Identit√† ¬∑ Dicembre 2025</div>
    </div>
  </header>

  <main>
    <div class="tabs">
      <button class="tab active" data-tab="oggi">Oggi</button>
      <button class="tab" data-tab="scrivi">Scrivi</button>
      <button class="tab" data-tab="diario">Diario</button>
      <button class="tab" data-tab="eventi">Eventi</button>
      <button class="tab" data-tab="appuntamenti">Appuntamenti</button>
    </div>

    <!-- OGGI -->
    <section class="card" id="tab-oggi">
      <div class="dev-header">
        <button class="nav-prev" id="prevDevoBtn" type="button">
          <span class="arrow">‚Üê</span><span>Ieri</span>
        </button>
        <div style="display:flex;align-items:center;gap:6px;">
          <div class="chip-date">
            <span></span>
            <span id="todayLabel">Oggi</span>
          </div>
          <button class="nav-today" id="todayDevoBtn" type="button">Oggi</button>
        </div>
      </div>
      <div class="dev-title" id="devTitle">Titolo</div>
      <div class="dev-ref" id="devRef">Riferimento</div>
      <div class="dev-verse" id="devVerse"></div>
      <div class="dev-content" id="devContent">Testo...</div>

      <!-- NUOVO: Prossimo evento in home -->
      <div class="home-next-event" id="homeNextEventCard">
        <div class="section-title" style="margin-bottom:4px;">Prossimo evento</div>
        <div id="homeNextEventInner" class="small-note">
          Caricamento evento...
        </div>
      </div>
    </section>

    <!-- SCRIVI -->
    <section class="card" id="tab-scrivi" style="display:none;">
      <div class="section-title">La mia nota di oggi</div>
      <p style="font-size:13px;color:#ccc;margin-bottom:8px;">
        Prenditi un momento per scrivere cosa ti ha parlato oggi attraverso questo devozionale.
      </p>
      <textarea id="noteInput" placeholder="Cosa hai capito? Cosa senti che Dio ti stia dicendo?"></textarea>
      <div class="btn-row">
        <button class="btn btn-ghost" id="clearNote">Cancella</button>
        <button class="btn btn-primary" id="saveNote">Salva nota</button>
      </div>
      <div class="small-note">
        Le note vengono salvate solo su questo dispositivo (nessun altro le vede).
      </div>
    </section>

    <!-- DIARIO -->
    <section class="card" id="tab-diario" style="display:none;">
      <div class="section-title">Il mio diario</div>
      <div id="diaryList"></div>
      <div class="small-note">
        Tocca una nota per rileggerla e modificarla. Le note sono salvate solo su questo telefono.
      </div>
    </section>

    <!-- EVENTI -->
    <section class="card" id="tab-eventi" style="display:none;">
      <div class="section-title">Eventi in programma</div>
      <div id="eventsList" class="events-list"></div>
      <div class="small-note">
        Gli eventi sono sincronizzati con il foglio "eventi" del Google Sheet.
      </div>
    </section>

    <!-- APPUNTAMENTI -->
    <section class="card" id="tab-appuntamenti" style="display:none;">
      <div class="section-title">Richiedi un appuntamento</div>
      <p style="font-size:13px;color:#ccc;margin-bottom:8px;">
        Compila i dati qui sotto per richiedere un appuntamento. Verrai ricontattato il prima possibile.
      </p>

      <div class="field-group">
        <div class="field-label">Nome e cognome</div>
        <input type="text" id="appFullName" class="input-text" placeholder="Es. Mario Rossi">
      </div>

      <div class="field-group">
        <div class="field-label">Numero di telefono</div>
        <input type="tel" id="appPhone" class="input-text" placeholder="Es. 3331234567">
      </div>

      <div class="field-group">
        <div class="field-label">Giorno preferito (lun‚Äìven)</div>
        <div class="days-row">
          <!-- value: 1=lun ... 5=ven -->
          <label class="day-chip">
            <input type="radio" name="appDay" value="1" data-label="Luned√¨" class="day-radio"> Lun
          </label>
          <label class="day-chip">
            <input type="radio" name="appDay" value="2" data-label="Marted√¨" class="day-radio"> Mar
          </label>
          <label class="day-chip">
            <input type="radio" name="appDay" value="3" data-label="Mercoled√¨" class="day-radio"> Mer
          </label>
          <label class="day-chip">
            <input type="radio" name="appDay" value="4" data-label="Gioved√¨" class="day-radio"> Gio
          </label>
          <label class="day-chip">
            <input type="radio" name="appDay" value="5" data-label="Venerd√¨" class="day-radio"> Ven
          </label>
        </div>
        <div class="small-note">
          Data proposta: <span id="appDatePreview">Seleziona un giorno‚Ä¶</span>
        </div>
      </div>

      <div class="field-group">
        <div class="field-label">Motivazione</div>
        <textarea id="appReason" placeholder="Scrivi brevemente il motivo dell'appuntamento"></textarea>
      </div>

      <div class="btn-row">
        <button class="btn btn-primary" id="appSubmit">Invia richiesta</button>
      </div>

      <div class="small-note">
        I dati vengono inviati alla chiesa nel foglio "Appuntamenti" e utilizzati solo per ricontattarti.
      </div>
    </section>
  </main>

  <footer>
    Chiesa Apostolica Carini - OSA - Rhema 2025
  </footer>
</div>

<script>
  // üëâ URL Apps Script per note + appuntamenti
  const ENDPOINT_URL = 'https://script.google.com/macros/s/AKfycbycboxlETWxHJ08dpr4vixz5U1ht_mKguOdekKf7OEoon6lCeWYN1fxf_bkkbWc_StU/exec';

  // üëâ URL CSV del foglio "eventi"
  const EVENTS_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS6Xgp-3pVR9RdoCX0QKT0FYWQulkdKmCqr3Ou4x-JRmv2QwL7nsm9RlDXe-i08IxuFp2ZwCqP2X0Ow/pub?gid=1100957392&single=true&output=csv';

  // üëâ URL CSV del foglio devozionali
  const DEVOS_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQHDbrymUnAs2GZoExowjFpbxzWUAi2PWL5z44qLFXly8ZF6MA929WC_c-V9mtG9i2U3fWQIH3MZME0/pub?gid=790463685&single=true&output=csv';

  const STORAGE_KEY = 'riseup_generazione_diario';
  const NAME_KEY    = 'riseup_user_name';
  const CLIENT_KEY  = 'riseup_client_id';

  let eventsLoaded = false;
  let eventsData = null;
  let currentDevoDate = null;

  const defaultDevotionals = []; // fallback se il CSV non va
  let devotionals = defaultDevotionals.slice();

  function getTodayKey(){
    const d=new Date();
    const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,'0');
    const day=String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }

  function formatItalianDate(dateStr){
    const d=new Date(dateStr);
    if(isNaN(d.getTime())) return dateStr || '';
    return d.toLocaleDateString('it-IT',{weekday:'long',day:'2-digit',month:'long',year:'numeric'});
  }

  function getCurrentDevo(){
    if(!devotionals || !devotionals.length) return null;

    if(currentDevoDate){
      const found = devotionals.find(d=>d.date===currentDevoDate);
      if(found) return found;
    }

    const todayKey = getTodayKey();
    const list = devotionals.slice().sort((a,b)=>a.date.localeCompare(b.date));

    let devo = list.find(d=>d.date===todayKey);
    if(devo){
      currentDevoDate = devo.date;
      return devo;
    }

    let lastPast = null;
    list.forEach(d=>{
      if(d.date <= todayKey) lastPast = d;
    });
    if(lastPast){
      currentDevoDate = lastPast.date;
      return lastPast;
    }

    currentDevoDate = list[0].date;
    return list[0];
  }

  function getClientId(){
    let cid = localStorage.getItem(CLIENT_KEY);
    if(!cid){
      cid = 'cid-' + Date.now() + '-' + Math.random().toString(16).slice(2);
      localStorage.setItem(CLIENT_KEY, cid);
    }
    return cid;
  }

  // üëâ Chiede SEMPRE il nome (non lo salva)
  function getUserName(){
    const name = prompt('Inserisci il tuo nome o nickname (per la chiesa):') || 'Anonimo';
    return name;
  }

  function loadNotes(){
    try{
      const raw=localStorage.getItem(STORAGE_KEY);
      return raw?JSON.parse(raw):[];
    }catch(e){
      console.error(e);return[];
    }
  }

  function saveNotes(notes){
    localStorage.setItem(STORAGE_KEY,JSON.stringify(notes));
  }

  function preloadTodayNote(dateStr){
    const notes=loadNotes();
    const existing=notes.find(n=>n.date===dateStr);
    document.getElementById('noteInput').value= existing ? existing.text : '';
  }

  function sendToSheet(payload){
    if(!ENDPOINT_URL){
      console.warn('ENDPOINT_URL non configurato');
      return;
    }
    const url = ENDPOINT_URL + '?payload=' + encodeURIComponent(JSON.stringify(payload));
    fetch(url, { method: 'GET', mode: 'no-cors' })
      .catch(err => console.error('Errore invio payload:', err));
  }

  function renderToday(){
    const devo=getCurrentDevo();
    if(!devo) return;

    const todayKey = getTodayKey();
    const labelEl = document.getElementById('todayLabel');
    const prevBtn = document.getElementById('prevDevoBtn');

    if(devo.date === todayKey){
      const today=new Date();
      labelEl.textContent =
        today.toLocaleDateString('it-IT',{weekday:'long',day:'2-digit',month:'long',year:'numeric'});
    }else{
      labelEl.textContent = formatItalianDate(devo.date);
    }

    const listPastOrToday = devotionals
      .slice()
      .filter(d=>d.date <= todayKey)
      .sort((a,b)=>a.date.localeCompare(b.date));
    const idx = listPastOrToday.findIndex(d=>d.date===devo.date);
    prevBtn.disabled = (idx <= 0);

    document.getElementById('devTitle').textContent=devo.title;
    document.getElementById('devRef').textContent=devo.ref;
    document.getElementById('devVerse').textContent=devo.verse || '';
    document.getElementById('devContent').textContent=devo.content;
    preloadTodayNote(devo.date);

    // aggiorna anche il prossimo evento in home
    renderHomeNextEvent();
  }

  function goPrevDevo(){
    const devo = getCurrentDevo();
    if(!devo) return;

    const todayKey = getTodayKey();

    const allowed = devotionals
      .slice()
      .filter(d=>d.date <= todayKey)
      .sort((a,b)=>a.date.localeCompare(b.date));

    const idx = allowed.findIndex(d=>d.date===devo.date);
    if(idx <= 0) return;

    currentDevoDate = allowed[idx-1].date;
    renderToday();
  }

  function goToday(){
    currentDevoDate = null;
    renderToday();
  }

  function handleSaveNote(){
    const devo=getCurrentDevo();
    if(!devo) return;

    const text=document.getElementById('noteInput').value.trim();
    if(!text){
      alert('Scrivi qualcosa prima di salvare üôÇ');
      return;
    }

    const notes=loadNotes();
    const idx=notes.findIndex(n=>n.date===devo.date);
    const now=new Date().toISOString();
    if(idx>=0){
      notes[idx].text=text;
      notes[idx].updatedAt=now;
    }else{
      notes.push({date:devo.date,title:devo.title,text,createdAt:now,updatedAt:now});
    }
    saveNotes(notes);

    const payload = {
      userName: getUserName(),
      clientId: getClientId(),
      devotionalDate: devo.date,
      devotionalTitle: devo.title,
      verseRef: devo.ref,
      noteText: text,
      createdAt: now
    };
    sendToSheet(payload);

    renderDiary();
    alert('Nota salvata su questo dispositivo ‚úÖ\nE inviata alla chiesa.');
  }

  function handleClearNote(){
    if(!confirm('Vuoi davvero cancellare il testo?')) return;
    document.getElementById('noteInput').value='';
  }

  function renderDiary(){
    const notes=loadNotes().sort((a,b)=>a.date.localeCompare(b.date));
    const box=document.getElementById('diaryList');
    box.innerHTML='';
    if(!notes.length){
      box.innerHTML='<div class="empty">Non hai ancora scritto nessuna nota. Inizia oggi dalla scheda ‚ÄúScrivi‚Äù.</div>';
      return;
    }
    notes.forEach(n=>{
      const div=document.createElement('div');
      div.className='diary-item';
      const d=document.createElement('div');
      d.className='diary-date';
      d.textContent=`${new Date(n.date).toLocaleDateString('it-IT',{day:'2-digit',month:'2-digit',year:'2-digit'})} ¬∑ ${n.title||''}`;
      const p=document.createElement('div');
      p.className='diary-preview';
      p.textContent=n.text;
      div.appendChild(d);div.appendChild(p);
      div.addEventListener('click',()=>{
        currentDevoDate = n.date;
        renderToday();
        document.getElementById('noteInput').value=n.text;
        setActiveTab('scrivi');
      });
      box.appendChild(div);
    });
  }

  function parseCSV(text){
    const rows=[];
    let row=[];
    let cur='';
    let inQuotes=false;

    for(let i=0;i<text.length;i++){
      const c=text[i];

      if(c === '"'){
        if(inQuotes && text[i+1] === '"'){
          cur+='"';
          i++;
        }else{
          inQuotes = !inQuotes;
        }
      }else if(c === ',' && !inQuotes){
        row.push(cur);
        cur='';
      }else if((c === '\n' || c === '\r') && !inQuotes){
        if(cur !== '' || row.length){
          row.push(cur);
          rows.push(row);
          row=[];
          cur='';
        }
        if(c === '\r' && text[i+1] === '\n') i++;
      }else{
        cur+=c;
      }
    }
    if(cur !== '' || row.length){
      row.push(cur);
      rows.push(row);
    }
    return rows;
  }

  function parseDevoDate(str){
    if(!str) return null;
    str = String(str).trim();
    if(/^\d{4}-\d{2}-\d{2}$/.test(str)) return str;
    const parts = str.split('/');
    if(parts.length === 3){
      let d = parts[0].padStart(2,'0');
      let m = parts[1].padStart(2,'0');
      let y = parts[2];
      if(y.length === 2) y = '20' + y;
      if(y.length === 4){
        return `${y}-${m}-${d}`;
      }
    }
    return null;
  }

  function fetchDevotionals(){
    if(!DEVOS_CSV_URL) return Promise.resolve(defaultDevotionals);

    return fetch(DEVOS_CSV_URL)
      .then(r=>r.text())
      .then(text=>{
        const rows = parseCSV(text);
        if(!rows.length) return defaultDevotionals;

        const headers = rows[0].map(h=>h.trim().toLowerCase());
        const idx = {};
        headers.forEach((h,i)=>{ idx[h]=i; });

        function col(){
          for(let i=0;i<arguments.length;i++){
            const key = arguments[i];
            if(idx[key] !== undefined) return idx[key];
          }
          return -1;
        }

        const iDate    = col('data','date','giorno');
        const iTitle   = col('titolo','title');
        const iRef     = col('riferimento','riferimento biblico','rif bibiclo','rif biblico','rif.');
        const iVerse   = col('verso','versetto','testo versetto');
        const iContent = col('contenuto','commento','testo','devocionale');

        if(iDate<0 || iTitle<0 || iRef<0 || iContent<0){
          console.warn('Colonne devozionali non trovate nel CSV, uso il fallback interno.');
          return defaultDevotionals;
        }

        const list = rows.slice(1).map(r=>{
          const d = parseDevoDate(r[iDate] || '');
          return {
            date: d || '',
            title: r[iTitle] || '',
            ref: r[iRef] || '',
            verse: iVerse>=0 ? (r[iVerse] || '') : '',
            content: r[iContent] || ''
          };
        }).filter(d => d.date && d.title && d.content);

        if(!list.length){
          console.warn('CSV devozionali vuoto o non valido, uso fallback.');
          return defaultDevotionals;
        }

        return list;
      })
      .catch(err=>{
        console.error('Errore caricamento devozionali da CSV:', err);
        return defaultDevotionals;
      });
  }

  function parseEventDate(ev){
    if(!ev.data) return null;
    const parts = ev.data.split('/');
    if(parts.length < 3) return null;
    const d = Number(parts[0]);
    const m = Number(parts[1]);
    const y = Number(parts[2]);
    if(!y || !m || !d) return null;
    let hh = 0, mm = 0;
    if(ev.ora){
      const t = ev.ora.split(':');
      hh = Number(t[0]) || 0;
      mm = Number(t[1]) || 0;
    }
    return new Date(y, m-1, d, hh, mm);
  }

  function fetchEvents(){
    if(eventsLoaded) return Promise.resolve(eventsData || []);
    return fetch(EVENTS_CSV_URL)
      .then(r=>r.text())
      .then(text=>{
        const rows = parseCSV(text);
        if(!rows.length) return [];
        const headers = rows[0].map(h=>h.trim().toLowerCase());
        const idx = {};
        headers.forEach((h,i)=>{ idx[h]=i; });

        const list = rows.slice(1).map(r=>({
          giorno: r[idx['giorno']] || '',
          data: r[idx['data']] || '',
          ora: r[idx['ora']] || '',
          evento: r[idx['evento']] || '',
          luogo: r[idx['luogo']] || '',
          descrizione: r[idx['descrizione']] || '',
          prenotazione: r[idx['prenotazione']] || ''
        })).filter(e=>e.evento);

        list.forEach(ev=>{
          ev._dateObj = parseEventDate(ev);
        });

        eventsData = list;
        eventsLoaded = true;
        return list;
      })
      .catch(err=>{
        console.error('Errore caricamento eventi:', err);
        return [];
      });
  }

  function renderEvents(){
    const container = document.getElementById('eventsList');
    if(!container) return;
    container.innerHTML = '<div class="small-note">Caricamento eventi...</div>';

    fetchEvents().then(list=>{
      if(!list.length){
        container.innerHTML = '<div class="empty">Nessun evento disponibile al momento.</div>';
        return;
      }

      const now = new Date();
      const todayMidnight = new Date(now.getFullYear(), now.getMonth(), now.getDate());

      list.sort((a,b)=>{
        if(a._dateObj && b._dateObj) return a._dateObj - b._dateObj;
        if(a._dateObj) return -1;
        if(b._dateObj) return 1;
        return 0;
      });

      const upcoming = list.filter(ev => !ev._dateObj || ev._dateObj >= todayMidnight);
      const toShow = upcoming.length ? upcoming : list;

      container.innerHTML = '';
      toShow.forEach(ev=>{
        const wrap = document.createElement('div');
        wrap.className = 'event-item';

        const dateDiv = document.createElement('div');
        dateDiv.className = 'event-date';
        dateDiv.textContent = ev.data + (ev.ora ? ' ¬∑ ' + ev.ora : '');

        const titleDiv = document.createElement('div');
        titleDiv.className = 'event-title';
        titleDiv.textContent = ev.evento;

        const locDiv = document.createElement('div');
        locDiv.className = 'event-location';
        if(ev.luogo) locDiv.textContent = ev.luogo;

        const descDiv = document.createElement('div');
        descDiv.className = 'event-desc';
        if(ev.descrizione) descDiv.textContent = ev.descrizione;

        const bookDiv = document.createElement('div');
        bookDiv.className = 'event-booking';
        if(ev.prenotazione) bookDiv.textContent = ev.prenotazione;

        wrap.appendChild(dateDiv);
        wrap.appendChild(titleDiv);
        if(ev.luogo) wrap.appendChild(locDiv);
        if(ev.descrizione) wrap.appendChild(descDiv);
        if(ev.prenotazione) wrap.appendChild(bookDiv);

        container.appendChild(wrap);
      });
    });
  }

  // üëâ NUOVO: prossimo evento in home
  function renderHomeNextEvent(){
    const box = document.getElementById('homeNextEventInner');
    if(!box) return;

    fetchEvents().then(list=>{
      if(!list.length){
        box.textContent = 'Nessun evento in programma.';
        return;
      }

      const now = new Date();
      const todayMidnight = new Date(now.getFullYear(), now.getMonth(), now.getDate());

      list.sort((a,b)=>{
        if(a._dateObj && b._dateObj) return a._dateObj - b._dateObj;
        if(a._dateObj) return -1;
        if(b._dateObj) return 1;
        return 0;
      });

      const upcoming = list.filter(ev => ev._dateObj && ev._dateObj >= todayMidnight);
      const ev = upcoming[0] || list[0];

      const line1 = (ev.data || '') + (ev.ora ? ' ¬∑ ' + ev.ora : '');
      const line2 = ev.evento || '';
      const line3 = ev.luogo || '';

      box.innerHTML = `
        <div class="home-next-event-date">${line1 || 'Data da definire'}</div>
        <div class="home-next-event-title">${line2}</div>
        ${line3 ? `<div class="home-next-event-loc">${line3}</div>` : ''}
      `;
    }).catch(err=>{
      console.error('Errore prossimo evento home:', err);
      box.textContent = 'Non √® stato possibile caricare gli eventi.';
    });
  }

  function setActiveTab(name){
    document.querySelectorAll('.tab').forEach(btn=>{
      btn.classList.toggle('active',btn.dataset.tab===name);
    });
    document.getElementById('tab-oggi').style.display          = (name==='oggi') ? '' : 'none';
    document.getElementById('tab-scrivi').style.display        = (name==='scrivi') ? '' : 'none';
    document.getElementById('tab-diario').style.display        = (name==='diario') ? '' : 'none';
    document.getElementById('tab-eventi').style.display        = (name==='eventi') ? '' : 'none';
    document.getElementById('tab-appuntamenti').style.display  = (name==='appuntamenti') ? '' : 'none';

    if(name === 'eventi'){
      renderEvents();
    }
    if(name === 'diario'){
      renderDiary();
    }
    if(name === 'oggi'){
      renderHomeNextEvent();
    }
  }

  // APPUNTAMENTI ‚Äì calcolo data proposta
  function getNextDateForWeekday(weekdayNumber){
    // weekdayNumber: 1=lun ... 5=ven (come getDay lun=1)
    const now = new Date();
    const todayDow = now.getDay(); // 0=dom,1=lun,...6=sab
    let targetDow = weekdayNumber; // 1..5

    let diff = targetDow - todayDow;
    if(diff < 0) diff += 7; // prossimo giro
    const result = new Date(now.getFullYear(), now.getMonth(), now.getDate() + diff);
    return result;
  }

  function updateAppointmentPreview(){
    const radios = document.querySelectorAll('.day-radio');
    const preview = document.getElementById('appDatePreview');
    let selected = null;
    radios.forEach(r=>{
      if(r.checked) selected = r;
    });
    if(!selected){
      preview.textContent = 'Seleziona un giorno‚Ä¶';
      return;
    }
    const weekdayNum = parseInt(selected.value,10); // 1..5
    const label = selected.dataset.label || '';
    const dateObj = getNextDateForWeekday(weekdayNum);
    const dd = String(dateObj.getDate()).padStart(2,'0');
    const mm = String(dateObj.getMonth()+1).padStart(2,'0');
    const yyyy = dateObj.getFullYear();
    preview.textContent = `${label} ${dd}/${mm}/${yyyy}`;
  }

  function handleAppointmentSubmit(){
    const fullName = document.getElementById('appFullName').value.trim();
    const phone    = document.getElementById('appPhone').value.trim();
    const reason   = document.getElementById('appReason').value.trim();
    const radios   = Array.from(document.querySelectorAll('.day-radio'));
    const selected = radios.find(r=>r.checked);

    if(!fullName || !phone || !reason){
      alert('Compila nome, numero e motivazione prima di inviare.');
      return;
    }
    if(!selected){
      alert('Seleziona un giorno preferito (lun‚Äìven).');
      return;
    }

    const weekdayNum = parseInt(selected.value,10);
    const label = selected.dataset.label || '';
    const dateObj = getNextDateForWeekday(weekdayNum);
    const dd = String(dateObj.getDate()).padStart(2,'0');
    const mm = String(dateObj.getMonth()+1).padStart(2,'0');
    const yyyy = dateObj.getFullYear();
    const iso = `${yyyy}-${mm}-${dd}`;
    const displayShort = `${label.slice(0,3).toLowerCase()} ${dd}/${mm}`;

    const now = new Date().toISOString();

    const payload = {
      type: 'appointment',
      fullName: fullName,
      phone: phone,
      appointmentDateDisplay: displayShort, // per colonna D
      appointmentDateISO: iso,              // per colonna E
      reason: reason,
      clientId: getClientId(),
      createdAt: now
    };

    sendToSheet(payload);

    document.getElementById('appFullName').value = '';
    document.getElementById('appPhone').value = '';
    document.getElementById('appReason').value = '';
    radios.forEach(r=>r.checked = false);
    updateAppointmentPreview();

    alert('Richiesta inviata ‚úÖ\nVerrai ricontattato quanto prima.');
  }

  // Event listeners
  document.querySelectorAll('.tab').forEach(btn=>{
    btn.addEventListener('click',()=>{
      setActiveTab(btn.dataset.tab);
    });
  });

  document.getElementById('saveNote').addEventListener('click',handleSaveNote);
  document.getElementById('clearNote').addEventListener('click',handleClearNote);
  document.getElementById('prevDevoBtn').addEventListener('click', goPrevDevo);
  document.getElementById('todayDevoBtn').addEventListener('click', goToday);
  document.getElementById('appSubmit').addEventListener('click', handleAppointmentSubmit);
  document.querySelectorAll('.day-radio').forEach(r=>{
    r.addEventListener('change', updateAppointmentPreview);
  });

  // Init
  fetchDevotionals().then(list=>{
    devotionals = list.slice().sort((a,b)=>a.date.localeCompare(b.date));
    currentDevoDate = null;
    renderToday();
    renderDiary();
  });
</script>
</body>
</html>
