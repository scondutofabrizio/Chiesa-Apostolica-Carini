<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Chiesa Apostolica in Italia - Carini</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* Stessi stili che hai gi√†, senza modifiche */
    :root {
      --bg: #050608;
      --card-bg: #111318;
      --accent: #fbbf24;
      --accent-soft: #facc15;
      --accent-strong: #eab308;
      --accent-glow: rgba(250, 204, 21, 0.25);
      --text-main: #e5e7eb;
      --text-dim: #9ca3af;
      --border-subtle: rgba(148, 163, 184, 0.45);
      --pill-bg: rgba(15, 23, 42, 0.9);
      --pill-active-bg: rgba(15, 23, 42, 0.98);
    }
    /* ...tutti gli altri stili rimangono invariati... */
  </style>
</head>
<body>
  <div class="app-shell">
    <div class="app-inner">
      <!-- STATUS -->
      <div class="status-pill">
        <div class="status-icon">‚ú∂</div>
        <div class="status-text">Ristoro giornaliero</div>
      </div>

      <!-- BRAND -->
      <div class="brand-row">
        <div class="brand-main">
          <div class="brand-logo"><span>CA</span></div>
          <div class="brand-texts">
            <div class="brand-title">Chiesa Apostolica in Italia - Carini</div>
            <div class="brand-subtitle">Via Don Luigi Sturzo 188 - Carini</div>
          </div>
        </div>
        <div class="theme-badge">
          <div class="theme-dot"></div>
          <div>OSA ¬∑ Rhema 2025</div>
        </div>
      </div>

      <!-- DEVOZIONALE -->
      <div class="devo-card">
        <div class="card-header">
          <div class="card-header-title">
            <div class="devo-label">
              <div class="devo-label-dot"></div>
              Devozionale
            </div>
            <div class="devo-title" id="devo-titolo">Titolo devozionale</div>
          </div>
          <div class="today-pill">
            <div class="today-pill-dot"></div>
            <span id="oggi-label">Oggi</span>
          </div>
        </div>

        <div class="verse-block">
          <div class="verse-ref" id="devo-rif">Riferimento biblico</div>
          <div class="verse-text" id="devo-verso">Testo del verso del giorno.</div>
          <div class="verse-note" id="devo-testo"></div>
        </div>

        <div class="date-nav">
          <button class="date-btn" id="btn-prev">Giorno precedente</button>
          <button class="date-btn" id="btn-today">Torna a oggi</button>
        </div>

        <div class="event-card" id="prossimo-evento" style="display:none;">
          <div class="event-label">Prossimo evento</div>
          <div class="event-main">
            <div>
              <div class="event-title" id="evento-titolo">Titolo evento</div>
              <div class="event-meta">
                <span id="evento-quando">Data e ora</span> ¬∑
                <span id="evento-dove">Luogo</span>
              </div>
            </div>
            <div class="event-badge">Partecipa</div>
          </div>
        </div>
      </div>

      <!-- TABS -->
      <div class="tabs-row">
        <button class="tab active" data-tab="scrivi">
          <span class="tab-icon">‚úçÔ∏è</span>
          <span>Scrivi</span>
        </button>
        <button class="tab" data-tab="parla">
          <span class="tab-icon">ü§ù</span>
          <span>Parla con qualcuno</span>
        </button>
        <button class="tab" data-tab="eventi">
          <span class="tab-icon">üìÖ</span>
          <span>Eventi</span>
        </button>
      </div>

      <!-- TAB SCRIVI -->
      <div class="tab-content active" id="tab-scrivi">
        <div class="section">
          <div class="section-title-row">
            <div>
              <div class="section-title">Scrivi il tuo devozionale</div>
              <div class="section-sub">Alla data attualmente selezionata.</div>
            </div>
          </div>

          <div class="field-group">
            <label for="nome">Nome o nickname (opzionale)</label>
            <input type="text" id="nome" placeholder="Come ti chiami?" />
          </div>

          <div class="field-group">
            <label for="nota">Cosa ti ha trasmesso questo verso?</label>
            <textarea id="nota" placeholder="Scrivi qui la tua riflessione personale..."></textarea>
          </div>

          <div class="btn-row">
            <button class="btn btn-secondary" id="btn-clear-nota">üßπ Pulisci</button>
            <button class="btn btn-primary" id="btn-save-nota">üíæ Invia</button>
          </div>

          <div class="feedback" id="nota-feedback"></div>
        </div>
      </div>

      <!-- TAB PARLA / APPUNTAMENTI -->
      <div class="tab-content" id="tab-parla">
        <div class="section">
          <div class="section-title-row">
            <div>
              <div class="section-title">Parla con qualcuno</div>
              <div class="section-sub">Appuntamenti disponibili solo luned√¨‚Äìvenerd√¨.</div>
            </div>
          </div>

          <div class="field-group">
            <label for="nome-app">Nome e cognome</label>
            <input type="text" id="nome-app" placeholder="Nome e cognome" />
          </div>
          <div class="field-group">
            <label for="contatto-app">Telefono</label>
            <input type="text" id="contatto-app" placeholder="Es. 333 1234567" />
          </div>
          <div class="field-group">
            <label for="data-app">Data (gg/mm/aaaa)</label>
            <input type="text" id="data-app" placeholder="Es. 10/12/2025" />
          </div>
          <div class="field-group">
            <label for="ora-app">Ora (HH:MM)</label>
            <input type="text" id="ora-app" placeholder="Es. 20:30" />
          </div>
          <div class="field-group">
            <label for="motivo-app">Motivo (breve descrizione)</label>
            <textarea id="motivo-app" placeholder="Di cosa vorresti parlare?"></textarea>
          </div>

          <div class="btn-row">
            <button class="btn btn-secondary" id="btn-clear-app">üßπ Pulisci</button>
            <button class="btn btn-primary" id="btn-invia-app">üì© Invia richiesta</button>
          </div>

          <div class="feedback" id="app-feedback"></div>
        </div>
      </div>

      <!-- TAB EVENTI -->
      <div class="tab-content" id="tab-eventi">
        <div class="section">
          <div class="section-title-row">
            <div>
              <div class="section-title">Eventi della settimana</div>
              <div class="section-sub">Cosa sta succedendo in Chiesa Apostolica Carini.</div>
            </div>
          </div>
          <div class="event-list" id="lista-eventi"></div>
        </div>
      </div>

      <!-- FOOTER -->
      <div class="footer">
        <div class="footer-left">
          <div class="footer-title">Chiesa Apostolica in Italia - Carini</div>
          <div class="footer-sub">OSA ‚Äì Rhema 2025</div>
        </div>
        <div class="footer-right">
          <div class="chip">
            <div class="chip-dot"></div>
            <span>Ristoro giornaliero</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SCRIPT -->
  <script>
    const API = "https://script.google.com/macros/s/AKfycbx4NT11DqLhGYpP0PZid3t-NsZn1TJjLun_ReO1jZG-Hy1QwniE-BD8qfNiUZZeCWgTFg/exec";

    // TABS
    const tabButtons = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    tabButtons.forEach(btn => btn.addEventListener('click', () => {
      const tab = btn.dataset.tab;
      tabButtons.forEach(b => b.classList.remove('active'));
      tabContents.forEach(c => c.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('tab-' + tab).classList.add('active');
      if(tab==='eventi'){ caricaEventi(); }
    }));

    // DEVOZIONALE
    const titoloDev = document.getElementById('devo-titolo');
    const refDev = document.getElementById('devo-rif');
    const versoDev = document.getElementById('devo-verso');
    const testoDev = document.getElementById('devo-testo');
    const oggiLabel = document.getElementById('oggi-label');
    const prossimoEventoBox = document.getElementById('prossimo-evento');
    const eventoTitoloEl = document.getElementById('evento-titolo');
    const eventoQuandoEl = document.getElementById('evento-quando');
    const eventoDoveEl = document.getElementById('evento-dove');
    const btnPrev = document.getElementById('btn-prev');
    const btnToday = document.getElementById('btn-today');

    let devoCorrenteData = new Date();
    const oggi = new Date();

    function formattaDataItaliano(date){
      const giorni=['domenica','luned√¨','marted√¨','mercoled√¨','gioved√¨','venerd√¨','sabato'];
      const mesi=['gennaio','febbraio','marzo','aprile','maggio','giugno','luglio','agosto','settembre','ottobre','novembre','dicembre'];
      const g=giorni[date.getDay()];
      const d=String(date.getDate()).padStart(2,'0');
      const m=mesi[date.getMonth()];
      const y=date.getFullYear();
      return `${g} ${d} ${m} ${y}`;
    }

    function toYMD(date){
      const y=date.getFullYear();
      const m=String(date.getMonth()+1).padStart(2,'0');
      const d=String(date.getDate()).padStart(2,'0');
      return `${y}-${m}-${d}`;
    }

    async function caricaDevozionale(){
      const url = `${API}?date=${toYMD(devoCorrenteData)}`;
      try{
        const res = await fetch(url);
        const data = await res.json();
        const devo = data.devotional;
        if(devo){
          titoloDev.textContent=devo.titolo||'';
          refDev.textContent=devo.riferimento||'';
          versoDev.textContent=devo.testo||'';
          testoDev.textContent='';
        }else{
          titoloDev.textContent='Nessun devozionale trovato';
          refDev.textContent='';
          versoDev.textContent='';
          testoDev.textContent='';
        }

        const testoData=formattaDataItaliano(devoCorrenteData);
        const stessaGiornata = devoCorrenteData.toDateString() === oggi.toDateString();
        oggiLabel.textContent = stessaGiornata ? `Oggi ¬∑ ${testoData}` : testoData;

        if(data.nextEvent){
          prossimoEventoBox.style.display='block';
          eventoTitoloEl.textContent = data.nextEvent.titolo || '';
          eventoQuandoEl.textContent = data.nextEvent.data + (data.nextEvent.ora ? ' ¬∑ '+data.nextEvent.ora:'');
          eventoDoveEl.textContent = data.nextEvent.luogo || '';
        }else{
          prossimoEventoBox.style.display='none';
        }
      }catch(e){
        titoloDev.textContent='Errore nel caricamento';
        refDev.textContent='';
        versoDev.textContent='';
        testoDev.textContent='';
        prossimoEventoBox.style.display='none';
      }
    }

    btnPrev.addEventListener('click',()=>{ devoCorrenteData.setDate(devoCorrenteData.getDate()-1); caricaDevozionale(); });
    btnToday.addEventListener('click',()=>{ devoCorrenteData=new Date(); caricaDevozionale(); });
    caricaDevozionale();

    // SCRIVI DEVOZIONALE
    const nomeInput = document.getElementById('nome');
    const notaText = document.getElementById('nota');
    const btnSaveNota = document.getElementById('btn-save-nota');
    const btnClearNota = document.getElementById('btn-clear-nota');
    const notaFeedback = document.getElementById('nota-feedback');

    btnClearNota.addEventListener('click',()=>{ notaText.value=''; notaFeedback.textContent=''; notaFeedback.className='feedback'; });
    btnSaveNota.addEventListener('click',async()=>{
      notaFeedback.textContent=''; notaFeedback.className='feedback';
      const nome = nomeInput.value.trim();
      const testo = notaText.value.trim();
      if(!testo){ notaFeedback.textContent='Scrivi qualcosa prima di inviare.'; notaFeedback.classList.add('error'); return; }

      const payload={ type:'response', data_devozionale: toYMD(devoCorrenteData), nome: nome, testo_risposta: testo };
      try{
        const res = await fetch(API,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
        const json = await res.json();
        if(json.status && json.status!=='ok'){ notaFeedback.textContent=json.message||'Errore invio.'; notaFeedback.classList.add('error'); return; }
        notaFeedback.textContent='Risposta inviata.'; notaFeedback.classList.add('success'); notaText.value='';
      }catch(e){ notaFeedback.textContent='Errore di connessione.'; notaFeedback.classList.add('error'); }
    });

    // PARLA / APPUNTAMENTI
    const nomeApp=document.getElementById('nome-app');
    const contattoApp=document.getElementById('contatto-app');
    const dataApp=document.getElementById('data-app');
    const oraApp=document.getElementById('ora-app');
    const motivoApp=document.getElementById('motivo-app');
    const btnClearApp=document.getElementById('btn-clear-app');
    const btnInviaApp=document.getElementById('btn-invia-app');
    const appFeedback=document.getElementById('app-feedback');

    btnClearApp.addEventListener('click',()=>{ nomeApp.value=''; contattoApp.value=''; dataApp.value=''; oraApp.value=''; motivoApp.value=''; appFeedback.textContent=''; appFeedback.className='feedback'; });

    function parseDMY(str){
      const m=/^(\d{2})\/(\d{2})\/(\d{4})$/.exec(str); if(!m)return null;
      return new Date(parseInt(m[3],10),parseInt(m[2],10)-1,parseInt(m[1],10));
    }

    btnInviaApp.addEventListener('click',async()=>{
      appFeedback.textContent=''; appFeedback.className='feedback';
      const nome=nomeApp.value.trim(); const tel=contattoApp.value.trim(); const dataStr=dataApp.value.trim(); const oraStr=oraApp.value.trim(); const motivo=motivoApp.value.trim();
      if(!nome||!tel||!dataStr||!oraStr||!motivo){ appFeedback.textContent='Compila tutti i campi.'; appFeedback.classList.add('error'); return; }
      if(!/^\d{2}:\d{2}$/.test(oraStr)){ appFeedback.textContent="Inserisci l'ora in formato HH:MM."; appFeedback.classList.add('error'); return; }
      const d=parseDMY(dataStr); if(!d){ appFeedback.textContent="Inserisci la data in formato gg/mm/aaaa."; appFeedback.classList.add('error'); return; }
      const day=d.getDay(); if(day===0||day===6){ appFeedback.textContent='Solo lun‚Äìven.'; appFeedback.classList.add('error'); return; }

      const payload={ type:'appointment', Data:dataStr, Ora:oraStr, Nome:nome, Telefono:tel, Motivo:motivo };
      try{
        const res=await fetch(API,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
        const json=await res.json();
        if(json.status&&json.status!=='ok'){ appFeedback.textContent=json.message||'Errore invio.'; appFeedback.classList.add('error'); return; }
        appFeedback.textContent='Richiesta inviata.'; appFeedback.classList.add('success');
        nomeApp.value=''; contattoApp.value=''; dataApp.value=''; oraApp.value=''; motivoApp.value='';
      }catch(e){ appFeedback.textContent='Errore di connessione.'; appFeedback.classList.add('error'); }
    });

    // EVENTI
    const listaEventi=document.getElementById('lista-eventi');
    async function caricaEventi(){
      try{
        const res=await fetch(`${API}?week=1`);
        const data=await res.json();
        listaEventi.innerHTML='';
        if(data.weekEvents && data.weekEvents.length){
          data.weekEvents.forEach(ev=>{
            const div=document.createElement('div'); div.className='event-card';
            div.innerHTML=`<div class="event-label">${ev.titolo}</div><div class="event-meta">${ev.data} ${ev.ora?ev.ora:''} ¬∑ ${ev.luogo||''}</div>`;
            listaEventi.appendChild(div);
          });
        }else{ listaEventi.textContent='Nessun evento questa settimana.'; }
      }catch(e){ listaEventi.textContent='Errore caricamento eventi.'; }
    }
  </script>
</body>
</html>
