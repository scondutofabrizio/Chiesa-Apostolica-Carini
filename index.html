<script>
const API = 'https://script.google.com/macros/s/AKfycbx4NT11DqLhGYpP0PZid3t-NsZn1TJjLun_ReO1jZG-Hy1QwniE-BD8qfNiUZZeCWgTFg/exec';

let currentDate = new Date();

/* ================= UTIL ================= */

function iso(date){
  return date.toISOString().split('T')[0];
}

function formatIT(date){
  return date.toLocaleDateString('it-IT',{weekday:'long',day:'2-digit',month:'long',year:'numeric'});
}

/* ================= LOAD INIT ================= */

async function loadInit(){
  const res = await fetch(`${API}?action=init&date=${iso(currentDate)}`);
  const data = await res.json();

  renderDevotional(data.devotional);
  renderHomeEvent(data.nextEvent);
}

function renderDevotional(dev){
  if(!dev){
    document.getElementById('devTitle').textContent = 'Nessun devozionale';
    document.getElementById('devRef').textContent = '';
    document.getElementById('devContent').textContent = '';
    return;
  }

  document.getElementById('todayLabel').textContent = formatIT(new Date(dev.date));
  document.getElementById('devTitle').textContent = dev.title;
  document.getElementById('devRef').textContent = dev.ref;
  document.getElementById('devContent').textContent = dev.content;
}

function renderHomeEvent(ev){
  const box = document.getElementById('homeNextEventInner');
  if(!ev){
    box.textContent = 'Nessun evento in programma.';
    return;
  }
  box.innerHTML = `
    <div class="home-next-event-date">${ev.date} ${ev.time||''}</div>
    <div class="home-next-event-title">${ev.title}</div>
    <div class="home-next-event-loc">${ev.location||''}</div>
  `;
}

/* ================= NAV ================= */

document.getElementById('prevDevoBtn').onclick = ()=>{
  currentDate.setDate(currentDate.getDate()-1);
  loadInit();
};

document.getElementById('todayDevoBtn').onclick = ()=>{
  currentDate = new Date();
  loadInit();
};

/* ================= NOTE ================= */

document.getElementById('saveNote').onclick = async ()=>{
  const text = document.getElementById('noteInput').value.trim();
  if(!text){ alert('Scrivi qualcosa'); return; }

  const payload = {
    type: 'devotional_note',
    devotionalDate: iso(currentDate),
    userName: prompt('Nome o nickname') || 'Anonimo',
    noteText: text
  };

  await fetch(API,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(payload)
  });

  alert('Nota inviata ✅');
};

/* ================= APPUNTAMENTI ================= */

document.getElementById('appSubmit').onclick = async ()=>{
  const fullName = appFullName.value.trim();
  const phone = appPhone.value.trim();
  const reason = appReason.value.trim();
  if(!fullName || !phone || !reason){
    alert('Compila tutti i campi');
    return;
  }

  const payload = {
    type:'appointment',
    fullName,
    phone,
    appointmentDateISO: iso(new Date()),
    reason
  };

  await fetch(API,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(payload)
  });

  alert('Richiesta inviata ✅');
};

/* INIT */
loadInit();
</script>
